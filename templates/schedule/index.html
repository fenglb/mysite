{% extends "bootstrap_base.html" %}
{% block title %} 仪器预约 {% endblock %}
{% block css_js %}
{% load staticfiles %}
<script src="{% static 'js/moment.min.js' %}"></script>
<script src="{% static 'js/fullcalendar.js' %}"></script>
<script src="{% static 'js/jquery.simple-dtpicker.js' %}"></script>
<link href="{% static 'css/fullcalendar.css' %}" rel="stylesheet" />
<link href="{% static 'css/jquery.simple-dtpicker.css' %}" rel="stylesheet" />
<script type="text/javascript">
	$(document).ready(function() {
		$('#calendar').fullCalendar({
		    header: {
				left: 'prev,next today',
				center: 'title',
				right: 'month, customWeek, basicWeek'
			    },
		    defaultDate: '{% now "Y-m-d" %}',
		    events: { url: "{% url 'schedule:getEvent' instrument|default_if_none:'all' %}", },
		    timeFormat: 'H:mm',
		    eventLimit: true,
		    displayEventEnd: true,
		    views: {
			  customWeek: { 
			  type: 'agenda',
			  buttonText: 'agenda',
			  duration: { week:  1, },
			  slotDuration: '00:15:00',
			  }
		    },
        eventClick: function( event, jsEvent, view) {
          $(this).popover({title: event, placement: 'bottom'});
        },
        selectable: true,
		    selectHelper: true,
        select: function(start, end) {
          var start0 = moment(start);
		      var end0 = moment(end);
          var diff = 1.0*(end-start)/(3600*1000);
          var start0 = start0.format("YYYY-MM-DD HH:mm");
          var end0 = end0.format("YYYY-MM-DD HH:mm");
		      var now = moment();
		      var week = now.week();
		      var startWeek = moment(start).week();
		      if ( startWeek - week > 1 ) return;
		      if ( moment(start).isBefore(now)) return;

          $('#id_start_time').val( start0 );
          $('#id_end_time').val( end0 );
          $('#id_times').val( diff );
          $('#create_experiment').modal( 'show' );
        },
		});
	});
</script>
<style>
  h4 {
    font-family: "AR PL UKai CN", "KaiTi", "STKaiti", monospace;
    font-weight: bold;
  }
  .schedule {
    border-bottom: 1px solid #555;
    padding-bottom: 20px;
  }
  .calendar {
    margin: 10px 40px 0px 40px;
  }
  #calendar {
    font-size: 14px;
    padding-top: 20px;
  }
 #calendar .fc-content {
   font-size: 10px;
   }
</style>
{% endblock %}

{% block content %}

<div class="container-fuild schedule">
  <div class="container">
    {% if user.is_anonymous %}
      您好！您还没有<a href="{% url 'accounts:login' %}">登录</a>，如果要预约实验，请参考<a href="{% url 'homepages:appoint' %}">仪器预约</a>!
    {% else %}
      {% if is_perm %}
        您可以预约实验，并且自主上机操作仪器“{{ instrument }}”！请在预约的时间做实验，遵守实验规则，有任何情况请联系管理员！
        
      {% else %}
        您不具有自主上机操作权限，没有办法自主预约实验！请选择<a href="">送样申请</a>或者提交<a href="{% url 'accounts:apermission' %}">自主上机操作申请</a>！
      {% endif %}
    {% endif %}
  </div>
</div>
<div class="container-fuild calendar">
  <div class="row">
    <div class="col-sm-3">
      <h4>预约日历操作说明</h4>
      <table class="table">
        <tbody>
          <tr>
            <td>month</td>
            <td>显示月</td>
          </tr>
          <tr>
            <td>agenda</td>
            <td>显示天</td>
          </tr>
          <tr>
            <td>week</td>
            <td>显示事件</td>
          </tr>
        </tbody>
      </table>
      
    </div>
    <div class="col-sm-9">
      <h4>仪器“{{ instrument|default_if_none:'所有仪器' }}”的预约情况</h4>
      <div id='calendar'></div>
    </div>
  </div>
</div>

{% if is_perm %}
<div class="modal fade" id="create_experiment" tabindex="-1" role="dialog" 
   aria-labelledby="myModalLabel" aria-hidden="true">
   <div class="modal-dialog">
      <div class="modal-content">
         <div class="modal-header">
            <button type="button" class="close" 
               data-dismiss="modal" aria-hidden="true">
                  &times;
            </button>
            <h3 class="modal-title text-center" id="myModalLabel">
              预约“{{ instrument|default_if_none:'' }}”实验
            </h3>
         </div>
         <div class="modal-body">
          <form action="{% url 'schedule:view' instrument %}" method="post">
            {% csrf_token %}
              <div class="row">
                <div class="form-group">
                  <div class="col-sm-4">
                    <label class="input-lg">{{ form.start_time.label_tag }}</label>
                  </div>
                  <div class="col-sm-8">
                    {{ form.start_time }}
                    {{ form.user }}
                    {{ form.instrument }}
                    {% if form.start_time.errors %}
                      <span class="text-danger">
                        {{ form.start_time.errors }}
                      </span>
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="form-group">
                  <div class="col-sm-4">
                    <label class="input-lg">结束时间:</label>
                  </div>
                  <div class="col-sm-8">
                    <input id="id_end_time" type="text" />
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="form-group">
                  <div class="col-sm-4">
                    <label class="input-lg">{{ form.times.label_tag }}</label>
                  </div>
                  <div class="col-sm-8">
                    {{ form.times }}
                    {% if form.times.errors %}
                      <span class="text-danger">
                        {{ form.times.errors }}
                      </span>
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="form-group">
                  <div class="col-sm-4">
                    <label class="input-lg">{{ form.measure_type.label_tag }}</label>
                  </div>
                  <div class="col-sm-8">
                    {{ form.measure_type }}
                    {% if form.measure_type.errors %}
                      <span class="text-danger">
                        {{ form.measure_type.errors }}
                      </span>
                    {% endif %}
                  </div>
                </div>
              </div>
         </div>

         <div class="modal-footer">
            <button type="button" class="btn btn-default" 
               data-dismiss="modal">关闭
            </button>
            <button type="submit" class="btn btn-primary">
               提交预约
            </button>
         </div>
          </form>
      </div><!-- /.modal-content -->
</div><!-- /.modal -->
{% endif %}
<script>
  $("input#id_start_time").appendDtpicker({'futureOnly': true });
  $("input#id_end_time").appendDtpicker({'futureOnly': true});
  $("input#id_start_time").attr('readonly', 'readonly');
  $("input#id_end_time").attr('readonly', 'readonly');

  $("input").toggleClass('form-control input-lg');
  $("textarea").toggleClass('form-control input-lg');
  $("select").toggleClass('form-control input-lg');
  $("select#id_user").hide();
  $("select#id_instrument").hide();
  $("input#id_times").change( function() {
      var start0 = moment($("input#id_start_time").val());
      var end = start0.add($(this).val(), 'h');
      var end0 = end.format("YYYY-MM-DD HH:mm");
      $("input#id_end_time").val( end0 );
    });
  $("input#id_start_time").change( function() {
      var start0 = moment($(this).val());
      var times  = $("input#id_times").val( );
      var end = start0.add(times, 'h');
      var end0 = end.format("YYYY-MM-DD HH:mm");
      $("input#id_end_time").val( end0 );
    });
  $("input#id_end_time").change( function() {
      var start0 = moment($("input#id_start_time").val());
      var end0 = moment($(this).val());
      var times = 1.0*(end0-start0)/(3600*1000);
      $("input#id_times").val( times );
    });
</script>


{% endblock %}
